---
title: "Using CVD Prevent"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{using_cvdprevent}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cvdprevent)
```

# Time periods

## Listing time periods

The CVD Prevent audit outputs data around four times a year. To see which are the four latest available periods for standard indicators you can use the function `cvd_time_period_list():`

```{r}
cvd_time_period_list() |> 
  dplyr::filter(IndicatorTypeName == 'Standard') |> 
  dplyr::slice_max(order_by = TimePeriodID, n = 4) |> 
  dplyr::select(TimePeriodID, TimePeriodName)
```

There are two main types of indicator reported; 'Standard' (ID1) and 'Outcomes' (ID2). Pass in an ID value for the optional parameter, `indicator_type_id` to get a list of time periods for which the indicator type was reported.

```{r}
cvd_time_period_list(indicator_type_id = 2) |> 
  dplyr::slice_max(order_by = TimePeriodID, n = 4) |> 
  dplyr::select(IndicatorTypeID, IndicatorTypeName, TimePeriodID, TimePeriodName)
```

## Listing system levels per period

Data can be reported at different geographies (aka System Levels) in each period; typically ranging from individual GP practices to national level (England). To get the available system levels we can use the `cvd_time_period_system_levels()` function.

```{r}
cvd_time_period_system_levels() |> 
  dplyr::slice_max(order_by = TimePeriodID) |> 
  dplyr::select(TimePeriodID, TimePeriodName, SystemLevelID, SystemLevelName)
```

# Areas

## List available system levels for a given time period

To find out which system levels are reported for a specific time period you can use the `cvd_area_system_level()` function, providing the required time_period_id, (NB, time_period_id defaults to the first time period if not supplied).

```{r}
cvd_area_system_level(time_period_id = 17) |> 
  dplyr::select(SystemLevelID, SystemLevelName)
```

## List all available reporting periods for each system level

Use the `cvd_area_system_level_time_periods()` function to show a list of all reporting periods for each system level. Here we show the latest four reporting periods at the GP practice system level.

```{r}
cvd_area_system_level_time_periods() |> 
  dplyr::filter(SystemLevelName == 'Practice') |> 
  dplyr::slice_max(order_by = TimePeriodID, n = 4) |> 
  dplyr::select(SystemLevelID, SystemLevelName, TimePeriodID, TimePeriodName)
```

## List areas for a time period and system level or parent area

To list four of the Primary Care Networks (PCN) (SystemLevelID = 4) for which data is available at time period 17 use the `cvd_area_list()` function.

```{r}
cvd_area_list(time_period_id = 17, system_level_id = 4) |> 
  dplyr::select(SystemLevelName, AreaID, AreaCode, AreaName) |> 
  dplyr::slice_head(n = 4)
```

## View details for a specific area

To view details for a specific area use `cvd_area_details()` with the required parameters of 'time_period_id' and 'area_id'. The return from this function is a list of three named tibbles:

-   `area_details`,

-   `area_child_details` (where appropriate), and

-   `area_parent_details` (where appropriate).

The tibbles first need extracting from the returned list object, done here using the `list$object` notation:

```{r}
# get the list from the function
returned_list <- cvd_area_details(time_period_id = 17, area_id = 1103)

# view area details
returned_list$area_details |> 
  dplyr::select(AreaCode, AreaName, SystemLevelID)

# view details for the parent of this area
returned_list$area_parent_details |> 
  dplyr::select(AreaID, AreaName, SystemLevelID)

# view details for the children of this area
returned_list$area_child_details |> 
  dplyr::select(AreaID, AreaName, SystemLevelID)
```

## List areas without parent details

Some areas do *not* have parent details but *do* have data reported in a given period, which may mean they are missed when searching for areas. This function provides a convenient way of accessing these details for a given 'time_period_id' and 'system_level_id'.

Here we report four GP practices without any parent PCN:

```{r}
cvd_area_unassigned(time_period_id = 17, system_level_id = 5) |> 
  dplyr::slice_head(n = 4) |> 
  dplyr::select(SystemLevelName, AreaID, AreaName)
```

The top system_level (England) does not have a parent either:

```{r}
cvd_area_unassigned(time_period_id = 17, system_level_id = 1) |> 
  dplyr::select(SystemLevelName, AreaID, AreaName)
```

## Search for area by keyword

To find details for an area where you don't know its ID number you can perform a partial name search using `cvd_area_search()` and specify a time period to search.

```{r}
cvd_area_search(partial_area_name = 'foo', time_period_id = 17) |> 
  dplyr::select(AreaID, AreaName, AreaCode)
```

## Area details

To get details for all areas as a tibble including children areas (and subchildren up to 3 levels deep) you can use the function `cvd_area_nested_subsystems()` function. No parameters are required.

```{r}
cvd_area_nested_subsystems() |> 
  dplyr::glimpse()
```

Alternatively, you can request a flat output grouped on system level using the `cvd_area_flat_subsystem()` function:

```{r}
cvd_area_flat_subsystems() |> 
  dplyr::glimpse()
```

# Indicators

An ***Indicator*** represents a cardiovascular disease health indicator as defined by NHS England. An example of an Indicator is CVDP001AF, 'Prevalence of GP recorded atrial fibrillation in patients aged 18 and over'. Indicators have unique Indicator IDs. Each indicator is further broken down into *Metrics*.

A ***Metric*** represents a further breakdown of an indicator by inequality markers. An example of an inequality marker is 'Age Group - Male, 40-59'. Metrics have unique Metric IDs with each representing a combination of *Indicator* and *Metric Category*.

A ***Metric Category*** describes the inequality markers which the *Metric* applies to. Each *Metric Category* has a unique ID for each combination of Name and *Metric Category Type*.

A *Metric Category* belongs to a ***Metric Category Type*** which groups the *Metric Categories* into one entity. Each *Metric Category Type* has a unique ID.

For example, 'Male - 40-59' is a *Metric Category* in the 'Age Group' *Metric Category Type*. Age Group will also contain categories for '18-39', '40-59', '60-79', '80+'. Assigning *Metric Categories* to *Metric Category Type* allows comparison of all metrics in one inequality marker (in this case Age Group), or displaying *Metric Categories* in the same *Metric Category Type* alongside each other.

## Listing indicators

To get a list of all available indicators for a given time period and system level you can use the `cvd_indicator_list()` function and specify which time period and system level you are interested in.

Here we access the first four indicators for time point 17 and GP practice level (system level 5).

```{r}
cvd_indicator_list(time_period_id = 17, system_level_id = 5) |> 
  dplyr::select(IndicatorID, IndicatorCode, IndicatorShortName) |> 
  dplyr::slice_head(n = 4)
```

## Listing metrics for each indicator

To list all metrics for each indicator you can use the `cvd_indicator_metric_list()` function and specify which time period and system level you are interested in.

Here we access the metrics for the prevalence of atrial fibrillation (Indicator ID 1) and focussing on just those metrics available for the 40-59 years age group:

```{r}
cvd_indicator_metric_list(time_period_id = 17, system_level_id = 1) |>
  dplyr::filter(IndicatorID == 1, MetricCategoryName == '40-59') |> 
  dplyr::count(IndicatorID, IndicatorShortName, MetricID, MetricCategoryName, CategoryAttribute) |> 
  dplyr::select(-n)
```

## List all indicator data for a given area

To access all indicator data for a given area and time period you can use the `cvd_indicator()` function. The return from the API includes four sets of data which are grouped together as four tibbles within a named list object. The four tibbles include:

-   indicators,

-   categories,

-   category data,

-   timeseries data,

Here we look at '3 Centres PCN' (area ID 1103) for time period 17:

```{r}
return_list <- cvd_indicator(time_period_id = 17, area_id = 1103) 
return_list |> summary()
```

We can extract the tibbles using the list\$object notation. To illustrate, we obtain the first four indicators from the `return_list$indicators` list item:

```{r}
return_list$indicators |> 
  dplyr::select(IndicatorID, IndicatorCode, IndicatorShortName) |> 
  dplyr::arrange(IndicatorID) |> 
  dplyr::slice_head(n = 4) |> 
  gt::gt()
```

Here we access category data for:

-   indicator 7: (AF: treatment with anticoagulants)

-   metric categories 7 & 8 (people aged 40-59 years by gender)

```{r}
return_list$categories |> 
  dplyr::filter(IndicatorID == 7, MetricCategoryID %in% c(7, 8)) |> 
  dplyr::select(IndicatorID, MetricCategoryTypeName, CategoryAttribute, MetricCategoryName, MetricID) |> 
  gt::gt()
```

Here we access the data for each of the above categories:

```{r}
return_list$category_data |> 
  dplyr::filter(MetricID %in% c(126, 132)) |>
  dplyr::select(IndicatorID, MetricID, Value, Numerator, Denominator) |> 
  gt::gt()
```

```{r}
return_list$timeseries_data |> 
  dplyr::filter(MetricID %in% c(126, 132), !is.na(Value)) |> 
  # prepare for plotting
  dplyr::mutate(
    EndDate = as.Date(EndDate, format = '%a, %d %b %Y 00:00:00 GMT'),
    MetricID = MetricID |> as.factor()
  ) |> 
  ggplot2::ggplot(ggplot2::aes(x = EndDate, y = Value, group = MetricID , colour = MetricID)) +
  ggplot2::geom_point() +
  ggplot2::geom_line()
```
